					===== Parallax PIC16Cxx Assembler v1.6 =====


     1
     2
     3                              	;PIC16C84 keybord controller for Amiga keybords
     4                              	;pressed keys are located in table and send in serial format (19200baud)
     5                              	;
     6                              	;Dirk Duesterberg duesterb@unixserv.rz.fh-hannover.de
     7                              	;                 http://linux.rz.fh-hannover.de/~duesterb
     8
     9
    10    0000-                     		DEVICE PIC16C84,HS_OSC,WDT_OFF,PROTECT_OFF
    11
    12                              		
    13
    14
    15    =0005                     	ACLK	=	RA.0
    16    =0085                     	ADAT	=	RA.1
    17
    18    =0105                     	TXD	=	RA.2
    19
    20
    21    =000C                     	count0	=	0Ch
    22    =000D                     	count1	=	0Dh
    23
    24    =000E                     	Akeydat	=	0Eh
    25    =000F                     	serbuf	=	0fh
    26
    27    0000- 30FB 0065           		mov	!RA,#11111011b		;pin 2 is output (TXD)
    28
    29    0002- 3000 0066           		mov	!RB,#0			;PortB is output
    30
    31    0004- 2888                		jmp	Reset
    32
    33
    34
    35    0005- 080E                	rawkeys	mov	w,Akeydat
    36    0006- 397F                		and	w,#7Fh			;clr bit 7 (make/break or pressed/unpressed)
    37    0007- 0782                		jmp	pc+w
    38
    39
    40                              	; characters, numbers and spezial keys
    41                              	; $00-$3F
    42
    43    0008- 3400                		retw	00h			;00h
    44    0009- 3400                		retw	00h			;01h
    45    000A- 3400                		retw	00h			;02h
    46    000B- 3400                		retw	00h			;03h
    47    000C- 3400                		retw	00h			;04h
    48    000D- 3400                		retw	00h			;05h
    49    000E- 3400                		retw	00h			;06h
    50    000F- 3400                		retw	00h			;07h
    51
    52    0010- 3400                		retw	00h			;08h
    53    0011- 3400                		retw	00h			;09h
    54    0012- 3400                		retw	00h			;0Ah
    55    0013- 3400                		retw	00h			;0Bh
    56    0014- 3400                		retw	00h			;0Ch
    57    0015- 3400                		retw	00h			;0Dh
    58    0016- 3400                		retw	00h			;0Eh	
    59    0017- 3400                		retw	00h			;0Fh
    60
    61
    62
    63    0018- 3471                		retw	'q'			;10h
    64    0019- 3477                		retw	'w'			;11h
    65    001A- 3465                		retw	'e'			;12h
    66    001B- 3472                		retw	'r'			;13h
    67    001C- 3474                		retw	't'			;14h
    68    001D- 347A                		retw	'z'			;15h
    69    001E- 3475                		retw	'u'			;16h
    70    001F- 3469                		retw	'i'			;17h
    71
    72    0020- 346F                		retw	'o'			;18h
    73    0021- 3470                		retw	'p'			;19h
    74    0022- 3481                		retw	'ü'			;1Ah
    75    0023- 342B                		retw	'+'			;1Bh
    76    0024- 3400                		retw	00h			;1Ch
    77    0025- 3400                		retw	00h			;1Dh
    78    0026- 3400                		retw	00h			;1Eh
    79    0027- 3400                		retw	00h			;1Fh
    80
    81
    82
    83    0028- 3461                		retw	'a'			;20h
    84    0029- 3473                		retw	's'			;21h
    85    002A- 3464                		retw	'd'			;22h
    86    002B- 3466                		retw	'f'			;23h
    87    002C- 3467                		retw	'g'			;24h
    88    002D- 3468                		retw	'h'			;25h
    89    002E- 346A                		retw	'j'			;26h
    90    002F- 346B                		retw	'k'			;27h
    91
    92    0030- 346C                		retw	'l'			;28h
    93    0031- 3494                		retw	'ö'			;29h
    94    0032- 3484                		retw	'ä'			;2Ah
    95    0033- 3400                		retw	00h			;2Bh
    96    0034- 3400                		retw	00h			;2Ch
    97    0035- 3400                		retw	00h			;2Dh
    98    0036- 3400                		retw	00h			;2Eh
    99    0037- 3400                		retw	00h			;2Fh
   100
   101
   102
   103    0038- 3400                		retw	00h			;30h
   104    0039- 3400                		retw	00h			;31h
   105    003A- 3400                		retw	00h			;32h
   106    003B- 3400                		retw	00h			;33h
   107    003C- 3400                		retw	00h			;34h
   108    003D- 3400                		retw	00h			;35h
   109    003E- 3400                		retw	00h			;36h
   110    003F- 3400                		retw	00h			;37h
   111
   112    0040- 3400                		retw	00h			;38h
   113    0041- 3400                		retw	00h			;39h
   114    0042- 3400                		retw	00h			;3Ah
   115    0043- 3400                		retw	00h			;3Bh
   116    0044- 3400                		retw	00h			;3Ch
   117    0045- 3400                		retw	00h			;3Dh
   118    0046- 3400                		retw	00h			;3Eh
   119    0047- 3400                		retw	00h			;3Fh
   120
   121                              	; other spezial keys (space, TAB, Return)
   122                              	; $40-$4F
   123
   124    0048- 3400                		retw	00h			;40h
   125    0049- 3400                		retw	00h			;41h
   126    004A- 3400                		retw	00h			;42h
   127    004B- 3400                		retw	00h			;43h
   128    004C- 3400                		retw	00h			;44h
   129    004D- 3400                		retw	00h			;45h
   130    004E- 3400                		retw	00h			;46h
   131    004F- 3400                		retw	00h			;47h
   132
   133    0050- 3400                		retw	00h			;48h
   134    0051- 3400                		retw	00h			;49h
   135    0052- 3400                		retw	00h			;4Ah
   136    0053- 3400                		retw	00h			;4Bh
   137    0054- 3400                		retw	00h			;4Ch
   138    0055- 3400                		retw	00h			;4Dh
   139    0056- 3400                		retw	00h			;4Eh
   140    0057- 3400                		retw	00h			;4Fh
   141
   142
   143                              	; Function keys, Help etc.
   144                              	; $50-$5F
   145
   146    0058- 3400                		retw	00h			;50h
   147    0059- 3400                		retw	00h			;51h
   148    005A- 3400                		retw	00h			;52h
   149    005B- 3400                		retw	00h			;53h
   150    005C- 3400                		retw	00h			;54h
   151    005D- 3400                		retw	00h			;55h
   152    005E- 3400                		retw	00h			;56h
   153    005F- 3400                		retw	00h			;57h
   154
   155    0060- 3400                		retw	00h			;58h
   156    0061- 3400                		retw	00h			;59h
   157    0062- 3400                		retw	00h			;5Ah
   158    0063- 3400                		retw	00h			;5Bh
   159    0064- 3400                		retw	00h			;5Ch
   160    0065- 3400                		retw	00h			;5Dh
   161    0066- 3400                		retw	00h			;5Eh
   162    0067- 3400                		retw	00h			;5Fh
   163
   164
   165
   166                              	; shifting keys like shift, amiga, Alternate and Control
   167                              	; $60-6F
   168                              		
   169    0068- 3400                		retw	00h			;60h
   170    0069- 3400                		retw	00h			;61h
   171    006A- 3400                		retw	00h			;62h
   172    006B- 3400                		retw	00h			;63h
   173    006C- 3400                		retw	00h			;64h
   174    006D- 3400                		retw	00h			;65h
   175    006E- 3400                		retw	00h			;66h
   176    006F- 3400                		retw	00h			;67h
   177
   178    0070- 3400                		retw	00h			;68h
   179    0071- 3400                		retw	00h			;69h
   180    0072- 3400                		retw	00h			;6Ah
   181    0073- 3400                		retw	00h			;6Bh
   182    0074- 3400                		retw	00h			;6Ch
   183    0075- 3400                		retw	00h			;6Dh
   184    0076- 3400                		retw	00h			;6Eh
   185    0077- 3400                		retw	00h			;6Fh
   186
   187
   188                              	;spezial keybord commandos
   189                              	; $70-$7F
   190
   191    0078- 3400                		retw	00h			;70h	
   192    0079- 3400                		retw	00h			;71h
   193    007A- 3400                		retw	00h			;72h
   194    007B- 3400                		retw	00h			;73h
   195    007C- 3400                		retw	00h			;74h
   196    007D- 3400                		retw	00h			;75h
   197    007E- 3400                		retw	00h			;76h
   198    007F- 3400                		retw	00h			;77h
   199
   200    0080- 3400                		retw	00h			;78h
   201    0081- 3400                		retw	00h			;79h=F9h= letzter tasten code war fehlerhaft
   202    0082- 3400                		retw	00h			;7Ah=FAh= tastenpuffer im keybord voll
   203    0083- 3400                		retw	00h			;7Bh
   204    0084- 3400                		retw	00h			;7Ch=FCh= selbsttest der tastatur war fehlerhaft
   205    0085- 3400                		retw	00h			;7Dh=FDh= beginn der beim Einschalten gedrueckten Tasten
   206    0086- 3400                		retw	00h			;7Eh=FEh= ende der beim Einschalten gedrueckten Tasten
   207    0087- 3400                		retw	00h			;7Fh
   208
   209                              		
   210
   211
   212
   213
   214
   215
   216
   217
   218
   219
   220
   221
   222
   223
   224
   225
   226
   227
   228
   229
   230
   231
   232    0088- 018E                	Reset	clr	Akeydat			;Akeydat is used as character counter
   233
   234    0089- 300B 020E 1903      	check	csne	Akeydat,#11		;how many characters ?
   235    008C- 289F                		jmp	ready
   236    008D- 2092                		call	dat
   237    008E- 008F                		mov	serbuf,w
   238    008F- 20D6                		call	sendb			;send letter
   239    0090- 0A8E                		inc	Akeydat
   240    0091- 2889                		jmp	check
   241
   242
   243
   244    0092- 080E                	dat	mov	w,Akeydat		;letter to w routine
   245    0093- 0782                		jmp	pc+w
   246    0094- 346D 3461 3463 3468 		retw	'mache RESET'
          0098- 3465 3420 3452 3445
          009C- 3453 3445 3454
   247
   248
   249
   250
   251
   252
   253
   254    009F- 20B2                	ready	call	sync
   255
   256
   257
   258
   259    00A0- 3007 008C           	rcAdat	mov	count0,#7
   260
   261    00A2- 20CD                	:loop	call	wACLK			;wait for Amiga CLK
   262    00A3- 0D8E                		rl	Akeydat			;rotate bits into register
   263    00A4- 0B8C 28A2           		djnz	count0,:loop		;format is x6543210
   264
   265
   266    00A6- 0D8E                		rl	Akeydat			;format is 6543210x
   267    00A7- 20CD                		call	wACLK			;wait for Amiga CLK
   268    00A8- 0C8E                		rr	Akeydat			;format is 76543210, jippije
   269    00A9- 098E                		not	Akeydat			;data is inverted
   270
   271    00AA- 3005                		mov	w,#5
   272    00AB- 20BA                		call	wms			;wait 5 ms
   273
   274                              	;	mov	serbuf,Akeydat
   275                              	;	call	sendb			;send raw data
   276
   277
   278    00AC- 2005                		call	rawkeys
   279    00AD- 008F                		mov	serbuf,w
   280
   281    00AE- 1F8E                		sb	Akeydat.7		;no sending if key up flag is set
   282    00AF- 20D6                		call	sendb			;send the in table found code
   283
   284    00B0- 20C3                		call	AHshake			;all data OK, do the Handshake
   285    00B1- 28A0                		jmp	rcAdat			;receive next byte from keybord
   286
   287
   288
   289
   290
   291
   292
   293
   294
   295
   296
   297    00B2- 20CD                	sync	call	wACLK			;wait for clock and do no Acknowledge
   298                              		
   299    00B3- 30FA                		mov	w,#250
   300    00B4- 20BA                		call	wms			;wait 250 ms (we want the sync mode!)
   301
   302    00B5- 20CD                		call	wACLK			;wait for Amiga CLK for Handshake
   303
   304    00B6- 3001                		mov	w,#1
   305    00B7- 20BA                		call	wms			;wait 1 ms
   306
   307    00B8- 20C3                		call	AHshake			;now we do the shake!
   308    00B9- 0008                		ret
   309
   310
   311                              	 
   312
   313
   314
   315    00BA- 008C                	wms	mov	count0,w
   316    00BB- 30F8 008D           	:loop	mov	count1,#248
   317    00BD- 0000                	:do_it	nop
   318    00BE- 0B8D 28BD           		djnz	count1,:do_it
   319    00C0- 0B8C 28BB           		djnz	count0,:loop
   320    00C2- 0008                		ret
   321
   322
   323
   324
   325
   326
   327    00C3- 30F9 0065           	AHshake	mov	!RA,#11111001b		;bit1 = ADAT = output
   328    00C5- 1085                		clrb	ADAT			;clr Amiga data line
   329                              		
   330    00C6- 3028 008C           		mov	count0,#40		;40 * 3 = 120cycles = 120 µs (min 75µs)
   331    00C8- 0B8C 28C8           	:do_it	djnz	count0,:do_it
   332
   333    00CA- 30FB 0065           		mov	!RA,#11111011b		;bit1 = ADAT = input
   334    00CC- 0008                		ret
   335
   336
   337
   338
   339
   340
   341    00CD- 1805                	wACLK	snb	ACLK			;wait for neg clock pulse
   342    00CE- 28CD                		jmp	wACLK
   343    00CF- 1C85 1003 1885 1403 		movb	c,Adat			;mov the data to carry bit
   344    00D3- 1C05                	wACLK2	sb	ACLK			;wait for pos clock pulse
   345    00D4- 28D3                		jmp	wACLK2
   346    00D5- 0008                		ret
   347
   348
   349
   350
   351
   352
   353
   354    00D6- 20E7                	sendb	call	wbit			;this are stop bits from previous sending
   355    00D7- 20E7                		call	wbit
   356
   357    00D8- 1505                		setb	TXD			;send startbit
   358    00D9- 3008 008C           		mov	count0,#8		;8 bits to send
   359    00DB- 098F                		not	serbuf			;invert serbuf
   360
   361    00DC- 20E7                	s_it	call	wbit
   362    00DD- 0C8F                		rr	serbuf
   363    00DE- 1C03 1105 1803 1505 		movb	TXD,c
   364    00E2- 0B8C 28DC           		djnz	count0,s_it		;all bits send ? decrement the bitcounter
   365
   366    00E4- 20E7                		call	wbit
   367    00E5- 1105                		clrb	TXD			;clear TXD, stopbit, lenght is defined by 
   368                              						;next sending
   369    00E6- 0008                		ret
   370
   371
   372
   373
   374
   375    00E7- 300D 008D           	wbit	mov	count1,#13		;19200 at 4 Mhz
   376    00E9- 0B8D 28E9           	:loop	djnz	count1,:loop
   377    00EB- 0000                		nop
   378    00EC- 0008                		ret


						    ===== Errors: 0 =====
